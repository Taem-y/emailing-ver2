import streamlit as st
from openai import OpenAI
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime

# 1. í™”ë©´ ê¸°ë³¸ ì„¤ì •
st.set_page_config(
    page_title="êµìˆ˜ë‹˜ê»˜ ì´ë©”ì¼ ì¨ì¤˜!!",
    page_icon="ğŸ“",
    layout="centered"
)

st.title("ğŸ“ êµìˆ˜ë‹˜ê»˜ ì´ë©”ì¼ ì¨ì¤˜!!")
st.subheader("ë§ì€ ì‹¤ì œ ì´ë©”ì¼ ì‚¬ë¡€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì´ë©”ì¼ ì‘ì„± AI")

# 2. API í‚¤ ì„¤ì • (ì•ˆì „ì¥ì¹˜)
# ì„œë²„(Secrets)ì— í‚¤ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ì…ë ¥ì°½ì„ ë„ì›Œì£¼ëŠ” 'í•˜ì´ë¸Œë¦¬ë“œ' ë°©ì‹
api_key = None

if "OPENAI_API_KEY" in st.secrets:
    api_key = st.secrets["OPENAI_API_KEY"]
else:
    st.warning("âš ï¸ ì„œë²„ì— API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì•„ë˜ì— í‚¤ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.")
    api_key = st.text_input("OpenAI API Key", type="password")

# 3. ì‚¬ìš©ì ì…ë ¥ í¼ (ìš”ì²­í•˜ì‹  ë””ìì¸ ì ìš© ì™„ë£Œ)
with st.form("email_form"):
    col1, col2 = st.columns(2)
    with col1:
        prof_name = st.text_input("êµìˆ˜ë‹˜ ì„±í•¨", placeholder="ì˜ˆ: ê¹€ì² ìˆ˜ êµìˆ˜ë‹˜")
        my_name = st.text_input("ë‚´ ì´ë¦„", placeholder="ì˜ˆ: í™ê¸¸ë™")
    with col2:
        course_name = st.text_input("ê°•ì˜ëª…", placeholder="ì˜ˆ: ë¶„ììƒë¬¼í•™")
        my_division = st.text_input("í•™ê³¼/í•™ë¶€", placeholder="ì˜ˆ: ìƒëª…ê³µí•™ë¶€")
        my_id = st.text_input("í•™ë²ˆ", placeholder="ì˜ˆ: 20251234")
    
    category = st.radio(
        "ë©”ì¼ì„ ë³´ë‚´ëŠ” ëª©ì :",
        ["ìˆ˜ì—… ë‚´ìš© ì§ˆì˜", "ì„±ì  ì´ì˜ ì œê¸°(ì •ì • ìš”ì²­)", "ì¶œì„ ì¸ì • ë¬¸ì˜", "ê³¼ì œ ì œì¶œ ì§€ê°/ì˜¤ë¥˜", "ê¸°íƒ€"]
    )
    
    reason = st.text_area("êµ¬ì²´ì ì¸ ì‚¬ìœ  (AIê°€ ì°¸ê³ í•  ë‚´ìš©ì„ í¸í•˜ê²Œ ì“°ë©´ ë¨!)", placeholder="ì˜ˆ: LMS ì˜¤ë¥˜ë¡œ ê³¼ì œê°€ ì œì¶œë˜ì§€ ì•Šì•˜ëŠ”ë° ì´ë©”ì¼ë¡œ ì œì¶œí•´ë„ ê´œì°®ì„ì§€")
    
    submit_btn = st.form_submit_button("ì´ë©”ì¼ ìƒì„±í•˜ê¸° âœ¨")

# 4. AI ìƒì„± ë¡œì§
if submit_btn:
    # ì˜ˆì™¸ ì²˜ë¦¬: í‚¤ê°€ ì—†ê±°ë‚˜ í•„ìˆ˜ ì •ë³´ê°€ ë¹ ì¡Œì„ ë•Œ
    if not api_key:
        st.error("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. Secrets ì„¤ì •ì„ í™•ì¸í•˜ê±°ë‚˜ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    elif not prof_name or not my_name or not course_name or not my_id or not reason:
        st.warning("âš ï¸ ë¹ˆì¹¸ì´ ìˆìŠµë‹ˆë‹¤! ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì•¼ ì´ë©”ì¼ì„ ìƒì„±í•  ìˆ˜ ìˆì–´ìš”.")
    else:
        try:
            # í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            client = OpenAI(api_key=api_key)
            
            with st.spinner("AIê°€ ê°€ì¥ ì •ì¤‘í•œ í‘œí˜„ì„ ê³ ë¥´ëŠ” ì¤‘ì…ë‹ˆë‹¤..."):
                
                # --- [í™•ì •ëœ í•µì‹¬ í”„ë¡¬í”„íŠ¸] ---
                prompt = f"""

                [ì˜ˆì‹œ1]
                ì œëª©: [ë¯¸ìƒë¬¼í•™2] 15ê°• End replication problem of DNA ì§ˆë¬¸ë“œë¦½ë‹ˆë‹¤
                ë‚´ìš©:
                ì•ˆë…•í•˜ì„¸ìš”, ë¯¸ìƒë¬¼í•™2 01ë¶„ë°˜ ìˆ˜ê°•ì¤‘ì¸ 2024140312 ìƒëª…ê³µí•™ë¶€ ì¡°ì˜ˆì€ì…ë‹ˆë‹¤. 
                Eukaryoteì˜ end replication problem of DNAì™€ ê´€ë ¨í•˜ì—¬ ê¶ê¸ˆí•œ ì ì´ ìˆì–´ ì§ˆë¬¸ ë“œë¦½ë‹ˆë‹¤. 
                lagging strandë¡œë¶€í„° í•©ì„±ëœ Okazaki fragmentì˜ 5' ë§ë‹¨ ë§ˆë‹¤ RNA primerê°€ ë¶™ì–´ìˆê³ , RNA primerì„ ì œê±°í•˜ê³  ê·¸ ìë¦¬ì— DNA ì¡°ê°ì„ ì§‘ì–´ë„£ê³  í‹ˆì„ ì—°ê²°í•˜ê¸° ìœ„í•´ì„œ ì–‘ ë(ìœ„,ì•„ë˜)ì— 3'-OHì™€ 5'-Pê°€ ëª¨ë‘ ìˆì–´ì•¼ í•œë‹¤ê³  ì´í•´í–ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ë§¨ ë§ˆì§€ë§‰ì— í•©ì„±ëœ Okazaki fragmentì˜ ê²½ìš° 5' ë§ë‹¨ì˜ RNA primerì„ ì œê±°í•˜ê³  ë‚˜ë©´ ìƒˆë¡œìš´ DNAê°€ë‹¥ì„ ì—°ê²°ì‹œí‚¬ 3'-OHê°€ ì—†ì–´ì„œ RNA primerë§Œ ì œê±°í•  ë¿ ìƒˆë¡œìš´ DNA ê°€ë‹¥ì„ ì—°ê²°í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë³µì œê°€ ì§„í–‰ë  ë•Œë§ˆë‹¤ ìƒˆë¡œ í•©ì„±ëœ DNAì˜ 5' ë§ë‹¨ì´ ì§§ì•„ì§€ê²Œ ë˜ëŠ”ê²Œ end replication problemì´ë¼ê³  ì´í•´í–ˆìŠµë‹ˆë‹¤. ê¶ê¸ˆí•œ ì ì€ ìœ„ ì´ìœ  ë•Œë¬¸ì— DNAê°€ ì§§ì•„ì§€ëŠ”ê²Œ ë¬¸ì œë¼ë©´, lagging strand ë¿ë§Œ ì•„ë‹ˆë¼ leading strandì—ì„œë„ end problemì´ ì¡´ì¬í•˜ëŠ” ê²ƒì¸ê°€ìš”? leading strandì—ì„œë„ 5' ë§ë‹¨ì— RNA primerê°€ ì¡´ì¬í•˜ê³ , 3'-OHê°€ ì—†ëŠ” ê²ƒì€ ë§ˆì°¬ê°€ì§€ì´ë‹ˆê¹Œ, ë˜‘ê°™ì´ ì§§ì•„ì§€ê²Œ ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ë‚˜ìš”? pptì—ëŠ” leading strand ì–¸ê¸‰ì€ ì—†ì´ ì˜¤ì§ lagging strandì˜ Okazaki fragmentë§Œì„ ì–¸ê¸‰í•˜ê³  ìˆì–´ ì´ ì ì—ì„œ ì˜ë¬¸ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤. 
                ê°ì‚¬í•©ë‹ˆë‹¤.

                [ì˜ˆì‹œ2]
                ì œëª©: [ìœ ê¸°í™”í•™2] 9ì›” 9ì¼ (í™”) ì¶œì„ ì¸ì • ìš”ì²­ë“œë¦½ë‹ˆë‹¤
                ë‚´ìš©:
                ì•ˆë…•í•˜ì„¸ìš” ì´ë™í˜¸ êµìˆ˜ë‹˜, ìœ ê¸°í™”í•™2 02ë¶„ë°˜ ìˆ˜ê°•ì¤‘ì¸ 2024140312 ìƒëª…ê³µí•™ë¶€ ì¡°ì˜ˆì€ì…ë‹ˆë‹¤. 
                ê¸ˆì¼ 2êµì‹œ ìˆ˜ì—…ì˜ ì˜¤í”„ë¼ì¸ ì¶œì„ì²´í¬ ê³¼ì •ì—ì„œ LMS ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì¶œì„ ì²´í¬ë¥¼ í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤. ë²ˆê±°ë¡œìš°ì‹œê² ì§€ë§Œ ê¸ˆì¼ ìˆ˜ì—… ì¶œì„ì´ ëˆ„ë½ë˜ì§€ ì•Šë„ë¡ ì¶œì„ ì¸ì • ì²˜ë¦¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. 
                ê°ì‚¬í•©ë‹ˆë‹¤.

                [ì˜ˆì‹œ3]
                ì œëª©: [ì‹ë¬¼ì˜í•™ê°œë¡ ] ì‹œí—˜ì§€ í™•ì¸ ì¼ì • ê´€ë ¨ ë¬¸ì˜ ë“œë¦½ë‹ˆë‹¤.
                ë‚´ìš©:
                ì •ì˜í™˜ êµìˆ˜ë‹˜ê»˜,
                ì•ˆë…•í•˜ì„¸ìš”, ì €ëŠ” ì‹ë¬¼ì˜í•™ê°œë¡ ì„ ìˆ˜ê°•í•œ ìƒëª…ê³µí•™ë¶€ 2024140253 ë°•í˜„ì˜ ì…ë‹ˆë‹¤. ë‹¤ë¦„ì´ ì•„ë‹ˆë¼ LMSì— ê³µì§€í•˜ì‹  í™”ìš”ì¼ ì‹œê°„ëŒ€ëŠ” ì œê°€ ê°œì¸ ì‚¬ì •ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•˜ì—¬ í˜¹ì‹œ ê°€ëŠ¥í•˜ì‹  ë‹¤ë¥¸ ë‚ ì´ ìˆëŠ”ì§€ ì–‘í•´ë¥¼ êµ¬í•˜ê³ ì ë©”ì¼ ë“œë¦½ë‹ˆë‹¤. ì €ëŠ” ìˆ˜ìš”ì¼ ëª¨ë“  ì‹œê°„ëŒ€, ëª©ìš”ì¼ ì˜¤í›„ 5ì‹œ ì´ì „, ê¸ˆìš”ì¼ ì˜¤í›„ 1ì‹œ ì´í›„ ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë²ˆê±°ë¡­ê²Œ í•´ë“œë ¤ ì£„ì†¡í•˜ë©°, ê°€ëŠ¥í•œ ì‹œê°„ì„ íšŒì‹  ì£¼ì‹œë©´ ê·¸ ì‹œê°„ì— ë§ì¶° ë°©ë¬¸í•˜ê² ìŠµë‹ˆë‹¤. ë‹µë³€ ê¸°ë‹¤ë¦¬ê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.
                ë°•í˜„ì˜ë“œë¦¼

                [ì˜ˆì‹œ4]
                ì œëª©: ìƒëª…ê³µí•™ì—ì„œ ë°”ë¼ë³¸ ì¸ì²´ì˜ ì‹ ë¹„ ì¶œì„ì— ê´€í•œ ê±´(2024140301 ì–‘í˜•ì„)
                ë‚´ìš©:
                ì•ˆë…•í•˜ì„¸ìš”
                ìƒëª…ê³µí•™ì—ì„œ ë°”ë¼ë³¸ ì¸ì²´ì˜ ì‹ ë¹„ ìˆ˜ì—…ì„ ìˆ˜ê°•í•œ 2024140301 ì–‘í˜•ì„ì…ë‹ˆë‹¤.
                ì¶œì„ê³¼ ê´€ë ¨í•˜ì—¬ 4/10(ëª©), 5/8(ëª©)ì— ë³‘ì›ì„ ë°©ë¬¸í•œ ì´í›„ KUPID ìƒìœ¼ë¡œ ì§„ë‹¨ì„œ ë° ì§„ë£Œí™•ì¸ì„œë¥¼ ì œì¶œí•˜ì˜€ìœ¼ë‚˜ ë°˜ì˜ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ë³´ì—¬ì„œ ì´ë©”ì¼ë¡œ ë¬¸ì˜ë“œë¦½ë‹ˆë‹¤.
                ê´€ë ¨í•˜ì—¬ 4/10(ëª©), 5/8(ëª©) ì§„ë‹¨ì„œ ë° ì§„ë£Œí™•ì¸ì„œë¥¼ ì²¨ë¶€í•˜ì˜€ìœ¼ë‹ˆ í™•ì¸í•´ì£¼ì‹œê³  ë°˜ì˜í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.
                ì–‘í˜•ì„ ë“œë¦¼.

                [ì •ë³´]
                - ìˆ˜ì‹ : {prof_name}
                - ê°•ì˜: {course_name}
                - ë°œì‹ : {my_name} ({my_division} , {my_id})
                - ëª©ì : {category}
                - ìƒì„¸ ë‚´ìš©: {reason}

                [ê°€ì¥ ì¤‘ìš”í•œ ì¡°ê±´]
                1. ì…ë ¥í•˜ì§€ ì•Šì€ ì •ë³´ ë° ì •í™•í•˜ì§€ ì•Šì€ ì •ë³´ì— ëŒ€í•˜ì—¬ ì¶”ì¸¡í•˜ì—¬ ì“°ì§€ ë§ ê²ƒ
                2. ìƒëŒ€ê°€ êµìˆ˜ì´ë¯€ë¡œ ê¸°ë³¸ì ìœ¼ë¡œ ê³µì†í•¨ê³¼ ì˜ˆì˜ë¥¼ ê°–ì¶œ ê²ƒ
                
                [ì¡°ê±´]
                1. ì œëª©ì€ í•œëˆˆì— ìš©ê±´ì„ ì•Œ ìˆ˜ ìˆê²Œ ì‘ì„±
                2. ì„œë‘ì— ì •ì¤‘í•œ ì¸ì‚¬ì™€ ì†Œì† ë°í˜(ë°œì‹ ì— ëŒ€í•œ ì •ë³´ë¥¼ ëª¨ë‘ ë°í ê²ƒ)
                3. ê³¼ë„í•œ ê³µì†ê³¼ ì˜ˆì˜ëŠ” ìì œí•  ê²ƒ(ê·¹ì¡´ì¹­ì„ ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²ƒ)
                4. ë§ˆì§€ë§‰ì— ë°”ì˜ì‹  ì™€ì¤‘ì— ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•˜ë‹¤ëŠ” ì¸ì‚¬ í¬í•¨
                5. ë¶„ëŸ‰ì´ ë„ˆë¬´ ì§§ì§€ì•Šë„ë¡ ì ì ˆíˆ ì‘ì„±í•  ê²ƒ
                6. ì˜ˆì‹œ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì‘ì„±í•  ê²ƒ

        


                """

                response = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[{"role": "user", "content": prompt}]
                )
                
                email_content = response.choices[0].message.content
                st.success("ìƒì„± ì™„ë£Œ! ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.")
                st.code(email_content, language="text")
                st.info("ğŸ’¡ Tip: ë‚´ìš©ì€ ìƒí™©ì— ë§ê²Œ ì¡°ê¸ˆ ìˆ˜ì •í•´ì„œ ë³´ë‚´ì„¸ìš”.")
# --- [ë°ì´í„°ë² ì´ìŠ¤ ëˆ„ì  ì €ì¥ ë¡œì§ (ìˆ˜ì •ë¨)] ---
                try:
                # 1. êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°
                    conn = st.connection("gsheets", type=GSheetsConnection)
                
                # 2. ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì´ê²Œ í•µì‹¬!)
                # ttl=0 ì˜µì…˜ì€ 'ìºì‹œ(ì„ì‹œì €ì¥)'ë¥¼ ì“°ì§€ ì•Šê³  ë§¤ë²ˆ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.
                    try:
                        existing_data = conn.read(worksheet="ì‹œíŠ¸1", usecols=list(range(6)), ttl=0)
                        existing_data = existing_data.dropna(how="all") # ë¹ˆ ì¤„ ì œê±°
                    except Exception:
                    # ë§Œì•½ ì‹œíŠ¸ê°€ í…… ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ í‹€ì„ ë§Œë“­ë‹ˆë‹¤.
                        existing_data = pd.DataFrame(columns=["ë‚ ì§œ", "ì‚¬ìš©ì", "êµìˆ˜ë‹˜", "ëª©ì ", "ë‚´ìš©", "ìƒì„±ëœì´ë©”ì¼"])
                
                # 3. í˜„ì¬ ì…ë ¥í•œ ìƒˆ ë°ì´í„° ë§Œë“¤ê¸°
                    new_data = pd.DataFrame([{
                        "ë‚ ì§œ": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "ì‚¬ìš©ì": f"{my_name} ({my_id})",
                        "êµìˆ˜ë‹˜": prof_name,
                        "ëª©ì ": category,
                        "ë‚´ìš©": reason,
                        "ìƒì„±ëœì´ë©”ì¼": email_content
                    }])
                
                # 4. [ê¸°ì¡´ ë°ì´í„°] + [ìƒˆ ë°ì´í„°] í•©ì¹˜ê¸° (Concatenate)
                    updated_df = pd.concat([existing_data, new_data], ignore_index=True)
                
                # 5. í•©ì³ì§„ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì €ì¥í•˜ê¸°
                    conn.update(worksheet="ì‹œíŠ¸1", data=updated_df)
                
                    print("-> êµ¬ê¸€ ì‹œíŠ¸ ëˆ„ì  ì €ì¥ ì„±ê³µ!", flush=True)
                
                except Exception as e:
                # ì—ëŸ¬ê°€ ë‚˜ë„ ì‚¬ìš©ìì—ê² í‹° ì•ˆ ë‚´ê³  ì„œë²„ ë¡œê·¸ì—ë§Œ ë‚¨ê¹€
                    print(f"-> ì €ì¥ ì‹¤íŒ¨: {e}", flush=True)
                    
                
        except Exception as e:
            st.error(f"ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")








































